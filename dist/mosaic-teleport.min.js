/* 
 * mosaic-teleport v0.0.16 | License: MIT 
 */
!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b(require("mosaic-commons"),require("underscore"),require("superagent")):"function"==typeof define&&define.amd?define(["mosaic-commons","underscore","superagent"],b):"object"==typeof exports?exports["mosaic-teleport"]=b(require("mosaic-commons"),require("underscore"),require("superagent")):a["mosaic-teleport"]=b(a["mosaic-commons"],a.underscore,a.superagent)}(this,function(a,b,c){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={exports:{},id:d,loaded:!1};return a[d].call(e.exports,e,e.exports,b),e.loaded=!0,e.exports}var c={};return b.m=a,b.c=c,b.p="",b(0)}([function(a,b,c){var d,e;d=[c,c(1),c(4),c(5),c(6),c(7),c(4),c(8)],e=function(){var a=(c(2),c(4),c(3),c(1)),b=a.Teleport={ApiDescriptor:c(5),ApiDispatcher:c(6),PathMapper:c(7),HttpClient:c(4),HttpClientSuperagent:c(8)};return b.HttpClient.Superagent=b.HttpClientSuperagent,b}.apply(null,d),!(void 0!==e&&(a.exports=e))},function(b){b.exports=a},function(a){a.exports=b},function(a){a.exports=c},function(a,b,c){var d,e;d=[c,c(2),c(1)],e=function(){var a=c(1),b=a.Class,d=a.Errors,e=a.P,f=c(2),g=b.extend({initialize:function(a){if(this.setOptions(a),!this.options.baseUrl)throw d.newError('The "baseUrl" is not defined.').code(501)},exec:function(a){var b=this.newRequest(a),c=this.newResponse(b);return this.handle(b,c)},handle:function(a,b){var c=this,g=e.defer();try{c.http(a,b,function(a){try{if(!a){var c=parseInt(b.status)/100;if(c=100*parseInt(c),200!=c)if(b.body&&b.body.trace){a=d.fromJSON(b.body).code(b.status);var e=f.isArray(b.body.trace)?b.body.trace.join("\n"):""+b.body.trace;a.stack=e+"\n\n"+a.stack}else a=d.newError("Error: "+b.status).code(b.status)}if(a)throw a;g.resolve(b.body)}catch(h){g.reject(h)}})}catch(h){g.reject(h)}return g.promise},newRequest:function(a){return a=a||{},a.id=f.uniqueId("req-"),a.method=(a.method||"get").toUpperCase(),a.params=a.params||{},a.body=a.body||a.params||{},a.url=this._toUrl(a.path),a.query=a.query||{},a.headers=a.headers||{},a},newResponse:function(a){return{id:a.id,status:200,headers:{},body:null,error:null}},_toUrl:function(a){var b=this.options||{},c=b.baseUrl||"";return c+a},http:function(a,b,c){var e=d.newError("Not implemented");c(e)}});return g.newInstance=function(a){return new g.Superagent(a)},g}.apply(null,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[c,c(2),c(1),c(7),c(4)],e=function(){function a(a){return a&&""!==a?("/"!=a[0]&&(a="/"+a),"/"===a[a.length-1]&&(a=a.substring(0,a.length-1))):a="",a}var b=c(1),d=b.Class,e=b.Errors,f=b.P,g=c(2),h=c(7),i=c(4),j=d.extend({initialize:function(){this._config={},this._mapper=new h},add:function(b,c,d){if(g.isObject(b)){var e=b;b=e.path,c=e.http,d=e.method}b=a(b);var f=this._config[b]=this._config[b]||{};return f[c]=d,this._mapper.add(b,f),this},get:function(a){return this._mapper.find(a)},exportJson:function(){var a=[],b={api:a},c=this;return g.each(c._config,function(b,c){g.each(b,function(b,d){a.push({path:c,http:d,method:b})})}),a.sort(function(a,b){return a.path>b.path?1:a.path<b.path?-1:0}),b},importJson:function(a){var b,c=this;b=g.isObject(a)&&g.isArray(a.api)?a.api:g.toArray(a),g.each(b,function(a){c.add(a)})}});g.extend(j,{normalizePath:a,getDescriptor:function(a){var b=new j,c=j.getDescriptorJson(a);return b.importJson(c),b},getDescriptorJson:function(a){var b=[];return a=g.isFunction(a)?a.prototype:a,g.each(g.functions(a),function(c){var d=a[c];if(d.http&&d.path){var e={method:c,http:d.http,path:d.path};b.push(e)}}),b},bind:function(a,b,c){return c.http=b,c.path=a,c}});var k=d.extend({_wrapHandleMethod:function(a){return function(b,c){var d=this;return f.fin(f.then(function(){return d._beginHttpCall({req:b,res:c,stub:d})}).then(function(){return a.call(d,b,c)}),function(a,e){return d._endHttpCall({req:b,res:c,stub:d,err:a,result:e})})}},_beginHttpCall:function(a){g.isFunction(this.options.beginHttpCall)&&this.options.beginHttpCall(a)},_endHttpCall:function(a){g.isFunction(this.options.endHttpCall)&&this.options.endHttpCall(a)}});return j.HttpServerStub=k.extend({INFO_SUFFIX:".info",registerIn:function(b){var c=this,d=a(this.options.path)+"*";b.all(d,function(a,b){c.handle(a,b).done()})},initialize:function(b){if(this.setOptions(b),this.descriptor=this.options.descriptor,!this.descriptor){var c=this.options.instance||this;this.descriptor=j.getDescriptor(c)}this.options.path=a(this.options.path),this._doHandle=this._wrapHandleMethod(this._doHandle)},getDescriptor:function(){return this.descriptor},handle:function(a,b){var c=this;return f.then(function(){return c._doHandle(a,b)}).then(function(a){b.status(200).send(a||"")},function(a){var c=e.toJSON(a);c.status=c.status||500,b.status(c.status).send(c)})},_doHandle:function(a,b){var c=this,d=j.HttpServerStub.getPath(a);if(d=c._getLocalizedPath(d),c._isEndpointInfoPath(d)){var f=c.getEndpointJson();return f}var g=a.method.toLowerCase(),h=c.descriptor.get(d);if(!h)throw e.newError('Path not found "'+d+'"').code(404);var i=h.obj[g];if(!i)throw e.newError('HTTP method "'+g.toUpperCase()+'" is not supported. Path: "'+d+'".').code(404);return c._callMethod(a,b,i,h.params)},getEndpointJson:function(){var a=this,b=a.getDescriptor(),c=b.exportJson();return c.endpoint=a.options.path,c},_isEndpointInfoPath:function(a){if(""===a||"/"==a)return!0;var b=a.lastIndexOf(this.INFO_SUFFIX);return b>=0&&b===a.length-this.INFO_SUFFIX.length},_getInstance:function(){var a=this.options||{},b=a.instance||this;return b},_callMethod:function(a,b,c,d){var f=this,g=f._getInstance(a,b,c,d),h=g[c];if(!h)throw e.newError('Method "'+c+'" is not implemented').code(500);var i=f._getMethodParams(c,d,a,b);return h.call(g,i)},_getMethodParams:function(a,b,c){return g.extend({},c.query,c.body,c.cookies,b)},_getLocalizedPath:function(a){var b=this.options.path;return a.substring(b.length)}}),j.HttpServerStub.getPath=function(a){var b=a.path;if(!b||""===b){var c=a.url||"",d=c.indexOf("?");d>=0&&(c=c.substring(0,d)),d=c.indexOf("#"),d>=0&&(c=c.substring(0,d)),d=c.indexOf("/"),d>0&&(c=c.substring(d)),b=c}return b},j.HttpClientStub=k.extend({initialize:function(a){if(!a.descriptor)throw e.newError("API descriptor is not defined").code(501);var b=this;b.setOptions(a),b.descriptor=b.options.descriptor,b.client=b.options.client||b._newHttpClient(),b.handle=b._wrapHandleMethod(b.handle);var c=b.descriptor._config;g.each(c,function(a,c){g.each(a,function(a,d){b[a]=function(a){var e=b._getFullPath(c,a),f=b.client.newRequest({path:e,method:d,params:a}),g=b.client.newResponse(f);return b.handle(f,g)}})})},handle:function(a,b){return this.client.handle(a,b)},_newHttpClient:function(){return new i.newInstance(this.options)},_getFullPath:function(a,b){return h.formatPath(a,b)}}),j.HttpClientStub.load=function(a,b){g.isObject(a)&&(b=a,a=b.baseUrl),b=b||{};var c=new i.newInstance({baseUrl:a}),d=c.newRequest({path:""}),e=c.newResponse(d);return c.handle(d,e).then(function(a){var d=a.api,e=new j;return e.importJson(d),new j.HttpClientStub(g.extend(b,{path:a.endpoint,descriptor:e,client:c}))})},j}.apply(null,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[c,c(2),c(1),c(7),c(5)],e=function(){var a=c(1),b=a.P,d=a.Errors,e=a.Class,f=(c(2),c(7)),g=c(5),h=e.extend({initialize:function(a){this.setOptions(a),this.options.path=this._normalizePath(this.options.path),this._mapping=new f},addEndpoint:function(a){var b=this,c=b._prepareEndpointMask(a),d=b._newServerStub(a);b._mapping.add(c,d)},removeEndpoint:function(a){var c=this;return b.then(function(){var b=c._prepareEndpointMask({path:a}),e=c._mapping.remove(b);if(!e)throw d.newError('No endpoint is registered for this path. Path: "'+a+'".').code(404)})},handle:function(a,c){var e=this;return b.then(function(){var b=g.HttpServerStub.getPath(a);return e.loadEndpoint(b).then(function(e){if(e)return e.handle(a,c);throw d.newError(404,'API handler not found. Path: "'+b+'".')})}).then(null,function(a){var b=d.toJSON(a);b.status=b.status||500,c.send(b.status,b)})},loadEndpoint:function(a){var c=this;return b.then(function(){a=c._normalizePath(a);var d=c._mapping.find(a);return d?d:b.then(function(){return c._loadEndpoint(a)}).then(function(b){return b&&(c.addEndpoint(b),d=c._mapping.find(a)),d})}).then(function(a){return a?a.obj:null})},_newServerStub:function(a){var b=a.stub||a.instance;if(!b)throw d.newError("API implementation is not defined");var c;return c=g.HttpServerStub.hasInstance(b)?b:new g.HttpServerStub(a)},_loadEndpoint:function(){return null},_prepareEndpointMask:function(a){var b=this;if(!a.path)throw d.newError("Path is not defined");var c=a.path.lastIndexOf(".");return c>=0&&(a.path=a.path.substring(0,c)),a.path=b._normalizePath(a.path),a.mask=a.path+"*prefix",a.mask},_normalizePath:function(a){return a&&""!==a?("/"!=a[0]&&(a="/"+a),"/"===a[a.length-1]&&(a=a.substring(0,a.length-1))):a="",a}});return h}.apply(null,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[c,c(2),c(1)],e=function(){function a(a){return a.replace(h,"\\$&")}function b(a){return"("+a+")"}var d=c(1),e=d.Class,f=c(2),g=e.extend({initialize:function(){var a=this;a.handlers=[]},add:function(c,d){var e=this,g=[],h=[],i=!1;f.each(c.split("*"),function(c){var d=!1;f.each(c.split(":"),function(c){if(i||d){if(i||d){var e=c.indexOf("/"),f=d?"[^/]+":".*?";e>=0?(g.push(b(f)),h.push(c.substring(0,e)),g.push(a(c.substring(e)))):(g.push(b(f)),h.push(c))}}else g.push(a(c));d=!0}),i=!0});var j=g.join(""),k=new RegExp("^"+j+"$");e.handlers.push({mask:c,regexp:k,names:h,obj:d})},find:function(a){var b=this,c=null;return f.any(b.handlers,function(b){if(b.regexp.test(a)){var d={},e=b.regexp.exec(a),g=e.slice(1),h=0;return f.each(g,function(a){var c=b.names[h++],e=a?decodeURIComponent(a):null;d[c]=e}),c={params:d,obj:b.obj},!0}}),c},remove:function(a){var b=this,c=null;return b.handlers=f.filter(b.handlers,function(b){var d=!0;return b.mask===a&&(c=b.obj,d=!1),d}),c}});g.formatPath=function(a,b){b=b||{};for(var c=a.split(/[:\*]/gim),d=[],e=0;e<c.length;e++){var f=c[e];if(0===e)""!==f&&d.push(f);else{var g=null,h=f.indexOf("/");h>=0?(g=f.substring(0,h),f=f.substring(h)):(g=f,f=null);var i=b[g];if(!i){var j='Required parameter "'+g+'" not defined.',k=new Error(j);throw k._code=400,k}delete b[g],d.push(i),f&&""!==f&&d.push(f)}}return d.join("")};var h=/[\-{}\[\]+?.,\\\^$|#\s]/g;return g}.apply(null,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[c,c(2),c(3),c(4)],e=function(){var a=c(2),b=c(4),d=c(3),e=b.Superagent=b.extend({initialize:function(a){var c=b.prototype.initialize;c.call(this,a)},http:function(b,c,e){var f=(b.method||"get").toLowerCase();"delete"==f&&(f="del"),f=f.toLowerCase();var g=a.extend({},this.options.headers,b.headers),h=a.extend({},this.options.query,b.query),i=a.extend({},this.options.body,b.body);b.params&&("put"===f||"post"===f?a.extend(i,b.params):a.extend(h,b.params));var j=d[f](b.url);this.options.formEncoded&&j.type("form"),j.set(g).query(h).send(i).end(function(b,d){try{d?(c.status=d.status,a.extend(c.headers,d.headers||{}),c.body=d.body):c.status=b&&b.status?b.status:500,e(b)}catch(f){e(f)}})}});return e}.apply(null,d),!(void 0!==e&&(a.exports=e))}])});