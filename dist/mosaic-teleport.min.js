/*! mosaic-teleport v0.0.15 | License: MIT  */
!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b(require("mosaic-commons"),require("underscore"),require("superagent")):"function"==typeof define&&define.amd?define(["mosaic-commons","underscore","superagent"],b):"object"==typeof exports?exports["mosaic-teleport"]=b(require("mosaic-commons"),require("underscore"),require("superagent")):a["mosaic-teleport"]=b(a["mosaic-commons"],a.underscore,a.superagent)}(this,function(a,b,c){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={exports:{},id:d,loaded:!1};return a[d].call(e.exports,e,e.exports,b),e.loaded=!0,e.exports}var c={};return b.m=a,b.c=c,b.p="",b(0)}([function(a,b,c){a.exports=c(1),c(2),c(3),c(4),c(5),c(6)},function(b){b.exports=a},function(a,b,c){function d(a){return a&&""!==a?("/"!=a[0]&&(a="/"+a),"/"===a[a.length-1]&&(a=a.substring(0,a.length-1))):a="",a}var e=a.exports=c(1);c(4);var f=c(7);e.ApiDescriptor=e.Class.extend({initialize:function(){this._config={},this._mapper=new e.PathMapper},add:function(a,b,c){if(f.isObject(a)){var e=a;a=e.path,b=e.http,c=e.method}a=d(a);var g=this._config[a]=this._config[a]||{};return g[b]=c,this._mapper.add(a,g),this},get:function(a){return this._mapper.find(a)},exportJson:function(){var a=[],b={api:a},c=this;return f.each(c._config,function(b,c){f.each(b,function(b,d){a.push({path:c,http:d,method:b})})}),a.sort(function(a,b){return a.path>b.path?1:a.path<b.path?-1:0}),b},importJson:function(a){var b,c=this;b=f.isObject(a)&&f.isArray(a.api)?a.api:f.toArray(a),f.each(b,function(a){c.add(a)})}}),f.extend(e.ApiDescriptor,{normalizePath:d,getDescriptor:function(a){var b=new e.ApiDescriptor,c=e.ApiDescriptor.getDescriptorJson(a);return b.importJson(c),b},getDescriptorJson:function(a){var b=[];return a=f.isFunction(a)?a.prototype:a,f.each(f.functions(a),function(c){var d=a[c];if(d.http&&d.path){var e={method:c,http:d.http,path:d.path};b.push(e)}}),b},bind:function(a,b,c){return c.http=b,c.path=a,c}});var g=e.Class.extend({_wrapHandleMethod:function(a){return function(b,c){var d=this;return e.P.fin(e.P.then(function(){return d._beginHttpCall({req:b,res:c,stub:d})}).then(function(){return a.call(d,b,c)}),function(a,e){return d._endHttpCall({req:b,res:c,stub:d,err:a,result:e})})}},_beginHttpCall:function(a){f.isFunction(this.options.beginHttpCall)&&this.options.beginHttpCall(a)},_endHttpCall:function(a){f.isFunction(this.options.endHttpCall)&&this.options.endHttpCall(a)}});e.ApiDescriptor.HttpServerStub=g.extend({INFO_SUFFIX:".info",registerIn:function(a){var b=this,c=d(this.options.path)+"*";a.all(c,function(a,c){b.handle(a,c).done()})},initialize:function(a){if(this.setOptions(a),this.descriptor=this.options.descriptor,!this.descriptor){var b=this.options.instance||this;this.descriptor=e.ApiDescriptor.getDescriptor(b)}this.options.path=d(this.options.path),this._doHandle=this._wrapHandleMethod(this._doHandle)},getDescriptor:function(){return this.descriptor},handle:function(a,b){var c=this;return e.P.then(function(){return c._doHandle(a,b)}).then(function(a){b.status(200).send(a||"")},function(a){var c=e.Errors.toJSON(a);c.status=c.status||500,b.status(c.status).send(c)})},_doHandle:function(a,b){var c=this,d=e.ApiDescriptor.HttpServerStub.getPath(a);if(d=c._getLocalizedPath(d),c._isEndpointInfoPath(d)){var f=c.getEndpointJson();return f}var g=a.method.toLowerCase(),h=c.descriptor.get(d);if(!h)throw e.Errors.newError('Path not found "'+d+'"').code(404);var i=h.obj[g];if(!i)throw e.Errors.newError('HTTP method "'+g.toUpperCase()+'" is not supported. Path: "'+d+'".').code(404);return c._callMethod(a,b,i,h.params)},getEndpointJson:function(){var a=this,b=a.getDescriptor(),c=b.exportJson();return c.endpoint=a.options.path,c},_isEndpointInfoPath:function(a){if(""===a||"/"==a)return!0;var b=a.lastIndexOf(this.INFO_SUFFIX);return b>=0&&b===a.length-this.INFO_SUFFIX.length},_getInstance:function(){var a=this.options||{},b=a.instance||this;return b},_callMethod:function(a,b,c,d){var f=this,g=f._getInstance(a,b,c,d),h=g[c];if(!h)throw e.Errors.newError('Method "'+c+'" is not implemented').code(500);var i=f._getMethodParams(c,d,a,b);return h.call(g,i)},_getMethodParams:function(a,b,c){return f.extend({},c.query,c.body,c.cookies,b)},_getLocalizedPath:function(a){var b=this.options.path;return a.substring(b.length)}}),e.ApiDescriptor.HttpServerStub.getPath=function(a){var b=a.path;if(!b||""===b){var c=a.url||"",d=c.indexOf("?");d>=0&&(c=c.substring(0,d)),d=c.indexOf("#"),d>=0&&(c=c.substring(0,d)),d=c.indexOf("/"),d>0&&(c=c.substring(d)),b=c}return b},e.ApiDescriptor.HttpClientStub=g.extend({initialize:function(a){if(!a.descriptor)throw e.Errors.newError("API descriptor is not defined").code(501);var b=this;b.setOptions(a),b.descriptor=b.options.descriptor,b.client=b.options.client||b._newHttpClient(),b.handle=b._wrapHandleMethod(b.handle);var c=b.descriptor._config;f.each(c,function(a,c){f.each(a,function(a,d){b[a]=function(a){var e=b._getFullPath(c,a),f=b.client.newRequest({path:e,method:d,params:a}),g=b.client.newResponse(f);return b.handle(f,g)}})})},handle:function(a,b){return this.client.handle(a,b)},_newHttpClient:function(){return c(6),new e.HttpClient.Superagent(this.options)},_getFullPath:function(a,b){return e.PathMapper.formatPath(a,b)}}),e.ApiDescriptor.HttpClientStub.load=function(a,b){f.isObject(a)&&(b=a,a=b.baseUrl),b=b||{};var c=new e.HttpClient.Superagent({baseUrl:a}),d=c.newRequest({path:""}),g=c.newResponse(d);return c.handle(d,g).then(function(a){var d=a.api,g=new e.ApiDescriptor;return g.importJson(d),new e.ApiDescriptor.HttpClientStub(f.extend(b,{path:a.endpoint,descriptor:g,client:c}))})}},function(a,b,c){{var d=a.exports=c(1);c(7)}c(4),c(2);d.PathMapper;d.ApiDispatcher=d.Class.extend({initialize:function(a){this.setOptions(a),this.options.path=this._normalizePath(this.options.path),this._mapping=new d.PathMapper},addEndpoint:function(a){var b=this,c=b._prepareEndpointMask(a),d=b._newServerStub(a);b._mapping.add(c,d)},removeEndpoint:function(a){var b=this;return d.P.then(function(){var c=b._prepareEndpointMask({path:a}),e=b._mapping.remove(c);if(!e)throw d.Errors.newError('No endpoint is registered for this path. Path: "'+a+'".').code(404)})},handle:function(a,b){var c=this;return d.P.then(function(){var e=d.ApiDescriptor.HttpServerStub.getPath(a);return c.loadEndpoint(e).then(function(c){if(c)return c.handle(a,b);throw d.Errors.newError(404,'API handler not found. Path: "'+e+'".')})}).then(null,function(a){var c=d.Errors.toJSON(a);c.status=c.status||500,b.send(c.status,c)})},loadEndpoint:function(a){var b=this;return d.P.then(function(){a=b._normalizePath(a);var c=b._mapping.find(a);return c?c:d.P.then(function(){return b._loadEndpoint(a)}).then(function(d){return d&&(b.addEndpoint(d),c=b._mapping.find(a)),c})}).then(function(a){return a?a.obj:null})},_newServerStub:function(a){var b=a.stub||a.instance;if(!b)throw d.Errors.newError("API implementation is not defined");var c;return c=d.ApiDescriptor.HttpServerStub.hasInstance(b)?b:new d.ApiDescriptor.HttpServerStub(a)},_loadEndpoint:function(){return null},_prepareEndpointMask:function(a){var b=this;if(!a.path)throw d.Errors.newError("Path is not defined");var c=a.path.lastIndexOf(".");return c>=0&&(a.path=a.path.substring(0,c)),a.path=b._normalizePath(a.path),a.mask=a.path+"*prefix",a.mask},_normalizePath:function(a){return a&&""!==a?("/"!=a[0]&&(a="/"+a),"/"===a[a.length-1]&&(a=a.substring(0,a.length-1))):a="",a}})},function(a,b,c){function d(a){return a.replace(i,"\\$&")}function e(a){return"("+a+")"}var f=a.exports=c(1),g=c(7),h=f.PathMapper=f.Class.extend({initialize:function(){var a=this;a.handlers=[]},add:function(a,b){var c=this,f=[],h=[],i=!1;g.each(a.split("*"),function(a){var b=!1;g.each(a.split(":"),function(a){if(i||b){if(i||b){var c=a.indexOf("/"),g=b?"[^/]+":".*?";c>=0?(f.push(e(g)),h.push(a.substring(0,c)),f.push(d(a.substring(c)))):(f.push(e(g)),h.push(a))}}else f.push(d(a));b=!0}),i=!0});var j=f.join(""),k=new RegExp("^"+j+"$");c.handlers.push({mask:a,regexp:k,names:h,obj:b})},find:function(a){var b=this,c=null;return g.any(b.handlers,function(b){if(b.regexp.test(a)){var d={},e=b.regexp.exec(a),f=e.slice(1),h=0;return g.each(f,function(a){var c=b.names[h++],e=a?decodeURIComponent(a):null;d[c]=e}),c={params:d,obj:b.obj},!0}}),c},remove:function(a){var b=this,c=null;return b.handlers=g.filter(b.handlers,function(b){var d=!0;return b.mask===a&&(c=b.obj,d=!1),d}),c}});h.formatPath=function(a,b){b=b||{};for(var c=a.split(/[:\*]/gim),d=[],e=0;e<c.length;e++){var f=c[e];if(0===e)""!==f&&d.push(f);else{var g=null,h=f.indexOf("/");h>=0?(g=f.substring(0,h),f=f.substring(h)):(g=f,f=null);var i=b[g];if(!i){var j='Required parameter "'+g+'" not defined.',k=new Error(j);throw k._code=400,k}delete b[g],d.push(i),f&&""!==f&&d.push(f)}}return d.join("")};var i=/[\-{}\[\]+?.,\\\^$|#\s]/g},function(a,b,c){var d=a.exports=c(1),e=c(7);d.HttpClient=d.Class.extend({initialize:function(a){if(this.setOptions(a),!this.options.baseUrl)throw d.Errors.newError('The "baseUrl" is not defined.').code(501)},handle:function(a,b){var c=this,f=d.P.defer();try{c.http(a,b,function(a){try{if(!a){var c=parseInt(b.status)/100;if(c=100*parseInt(c),200!=c)if(b.body&&b.body.trace){a=d.Errors.fromJSON(b.body).code(b.status);var g=e.isArray(b.body.trace)?b.body.trace.join("\n"):""+b.body.trace;a.stack=g+"\n\n"+a.stack}else a=d.Errors.newError("Error: "+b.status).code(b.status)}if(a)throw a;f.resolve(b.body)}catch(h){f.reject(h)}})}catch(g){f.reject(g)}return f.promise},newRequest:function(a){return a=a||{},a.id=e.uniqueId("req-"),a.method=(a.method||"get").toUpperCase(),a.params=a.params||{},a.body=a.body||a.params||{},a.url=this._toUrl(a.path),a.query=a.query||{},a.headers=a.headers||{},a},newResponse:function(a){return{id:a.id,status:200,headers:{},body:null,error:null}},_toUrl:function(a){var b=this.options||{},c=b.baseUrl||"";return c+a},http:function(a,b,c){var e=d.Errors.newError("Not implemented");c(e)}})},function(a,b,c){var d=a.exports=c(1);c(5);var e=c(7),f=c(8);d.HttpClient.Superagent=d.HttpClient.extend({initialize:function(a){var b=d.HttpClient.prototype.initialize;b.call(this,a)},http:function(a,b,c){var d=(a.method||"get").toLowerCase();"delete"==d&&(d="del"),d=d.toLowerCase();var g=e.extend({},this.options.headers,a.headers),h=e.extend({},this.options.query,a.query),i=e.extend({},this.options.body,a.body);a.params&&("put"===d||"post"===d?e.extend(i,a.params):e.extend(h,a.params));var j=f[d](a.url);this.options.formEncoded&&j.type("form"),j.set(g).query(h).send(i).end(function(a,d){try{d?(b.status=d.status,e.extend(b.headers,d.headers||{}),b.body=d.body):b.status=a&&a.status?a.status:500,c(a)}catch(f){c(f)}})}})},function(a){a.exports=b},function(a){a.exports=c}])});