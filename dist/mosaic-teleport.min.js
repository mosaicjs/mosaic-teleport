/*! mosaic-teleport 2014-07-14 */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.mosaicTeleport=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){!function(a,b){"use strict";var c=a.exports=b("mosaic-commons");b("./Mosaic.ApiDescriptor");var d=b("underscore"),e=b("superagent");c.ApiDescriptor.SuperagentClientStub=c.ApiDescriptor.HttpClientStub.extend({initialize:function(a){var b=this.class.parent.prototype.initialize;b.call(this,a),this.client=e.agent()},_http:function(a,b,c){var e=a.method;"delete"==e&&(e="del");var f=this.client[e](a.url);d.each(a.headers,function(a,b){f=f.set(b,a)}),f=f.send(a.body),f.end(function(a,e){try{e?(b.status=e.status,d.extend(b.headers,e.headers||{}),b.body=e.body):b.status=a&&a.status?a.status:500,c(a)}catch(f){c(f)}})}})}(b,a)},{"./Mosaic.ApiDescriptor":2}],2:[function(a,b){!function(a,b){"use strict";var c=a.exports=b("mosaic-commons");b("./Mosaic.PathMapper");var d=b("underscore");c.ApiDescriptor=c.Class.extend({initialize:function(){this._config={},this.mapper=new c.PathMapper},add:function(a,b,c){var d=this._config[a]=this._config[a]||{};return d[b]=c,this.mapper.add(a,d),this},get:function(a){return this.mapper.find(a)}});var e=c.Class.extend({_wrapHandleMethod:function(a){return function(b,d){var e=this;return c.P.fin(c.P.then(function(){return e._beginHttpCall({req:b,res:d,stub:e})}).then(function(){return a.call(e,b,d)}),function(a,c){return e._endHttpCall({req:b,res:d,stub:e,err:a,result:c})})}},_beginHttpCall:function(a){d.isFunction(this.options.beginHttpCall)&&this.options.beginHttpCall(a)},_endHttpCall:function(a){d.isFunction(this.options.endHttpCall)&&this.options.endHttpCall(a)}});c.ApiDescriptor.HttpServerStub=e.extend({initialize:function(a){if(this.setOptions(a),!a.descriptor)throw c.Errors.newError(501,"API descriptor is not defined");this.descriptor=a.descriptor,this._doHandle=this._wrapHandleMethod(this._doHandle)},handle:function(a,b){var d=this;return c.P.then(function(){return d._doHandle(a,b)}).then(function(a){b.send(200,a||"")},function(a){var d=c.Errors.toJSON(a),e=d.status||500;b.send(e,d)})},_doHandle:function(a,b){var d=this,e=d._getPath(a),f=a.method.toLowerCase(),g=d.descriptor.get(e);if(!g)throw c.Errors.newError('Path not found "'+e+'"').code(404);var h=g.obj[f];if(!h)throw c.Errors.newError('HTTP method "'+f.toUpperCase()+'" is not supported. Path: "'+e+'".').code(404);return d._callMethod(a,b,h,g.params)},_getInstance:function(){var a=this.options||{},b=a.instance||this;return b},_callMethod:function(a,b,d,e){var f=this,g=f._getInstance(a,b,d,e),h=g[d];if(!h)throw c.Errors.newError('Method "'+d+'" is not implemented').code(500);var i=f._getMethodParams(d,e,a,b);return h.call(g,i)},_getMethodParams:function(a,b,c){return d.extend({},c.query,c.body,c.cookies,b)},_getPath:function(a){var b=a.path;if(!b||""===b){var c=a.url||"",d=c.indexOf("?");d>=0&&(c=c.substring(0,d)),d=c.indexOf("#"),d>=0&&(c=c.substring(0,d)),d=c.indexOf("/"),d>0&&(c=c.substring(d)),b=c}var e=this.options||{},f=e.pathPrefix||"";return b.substring(f.length)}}),c.ApiDescriptor.HttpClientStub=e.extend({initialize:function(a){if(!a.descriptor)throw c.Errors.newError(501,"API descriptor is not defined");if(!a.baseUrl)throw c.Errors.newError(501,'"baseUrl" is empty; API endpoint URL is not defined');var b=this;b.descriptor=a.descriptor,b.setOptions(a),b.handle=b._wrapHandleMethod(b.handle);var e=b.descriptor._config;d.each(e,function(a,c){d.each(a,function(a,d){b[a]=function(a){var e=b._newHttpRequest(c,d,a),f=b._newHttpResponse(e);return b.handle(e,f)}})})},_newHttpRequest:function(a,b,e){e=e||{};var f=c.PathMapper.formatPath(a,e),g=this._toUrl(f);return{id:d.uniqueId("req-"),url:g,method:b,query:{},headers:{},body:e||{}}},_newHttpResponse:function(a){return{id:a.id,status:200,headers:{},body:null,error:null}},handle:function(a,b){var d=this,e=c.P.defer();try{d._http(a,b,function(a){try{if(!a){var d=parseInt(b.status)/100;d=100*parseInt(d),200!=d&&(a=b.body&&b.body.trace?c.Errors.fromJSON(b.body).code(b.status):c.Errors.newError(""+b.status).code(b.status))}if(a)throw a;e.resolve(b.body)}catch(f){e.reject(f)}})}catch(f){e.reject(f)}return e.promise},_toUrl:function(a){var b=this.options||{},c=b.baseUrl||"";return c+a},_http:function(a,b,d){var e=c.Errors.newError("Not implemented");d(e)}})}(b,a)},{"./Mosaic.PathMapper":3}],3:[function(a,b){!function(a,b){"use strict";function c(a){return a.replace(h,"\\$&")}function d(a){return"("+a+")"}var e=a.exports=b("mosaic-commons"),f=b("underscore"),g=e.PathMapper=e.Class.extend({initialize:function(){var a=this;a.handlers=[]},add:function(a,b){var e=this,g=[],h=[],i=!1;f.each(a.split("*"),function(a){var b=!1;f.each(a.split(":"),function(a){if(i||b){if(i||b){var e=a.indexOf("/"),f=b?"[^/]+":".*?";e>=0?(g.push(d(f)),h.push(a.substring(0,e)),g.push(c(a.substring(e)))):(g.push(d(f)),h.push(a))}}else g.push(c(a));b=!0}),i=!0});var j=g.join(""),k=new RegExp("^"+j+"$");e.handlers.push({mask:a,regexp:k,names:h,obj:b})},find:function(a){var b=this,c=null;return f.any(b.handlers,function(b){if(b.regexp.test(a)){var d={},e=b.regexp.exec(a).slice(1),g=0;return f.each(e,function(a){var c=b.names[g++],e=a?decodeURIComponent(a):null;d[c]=e}),c={params:d,obj:b.obj},!0}}),c},remove:function(a){var b=this,c=null;return b.handlers=f.filter(b.handlers,function(b){var d=!0;return b.mask===a&&(c=b.obj,d=!1),d}),c}});g.formatPath=function(a,b){b=b||{};for(var c=a.split(/[:\*]/gim),d=[],e=0;e<c.length;e++){var f=c[e];if(0===e)""!==f&&d.push(f);else{var g=null,h=f.indexOf("/");h>=0?(g=f.substring(0,h),f=f.substring(h)):(g=f,f=null);var i=b[g];if(!i){var j='Required parameter "'+g+'" not defined.',k=new Error(j);throw k._code=400,k}delete b[g],d.push(i),f&&""!==f&&d.push(f)}}return d.join("")};var h=/[\-{}\[\]+?.,\\\^$|#\s]/g}(b,a)},{}],4:[function(a,b){b.exports=a("mosaic-commons"),a("./Mosaic.ApiDescriptor"),a("./Mosaic.PathMapper"),a("./Mosaic.ApiDescriptor.SuperagentClientStub")},{"./Mosaic.ApiDescriptor":2,"./Mosaic.ApiDescriptor.SuperagentClientStub":1,"./Mosaic.PathMapper":3}]},{},[4])(4)});