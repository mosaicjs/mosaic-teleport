/*! mosaic-teleport 2014-07-16 */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.mosaicTeleport=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){!function(a,b){"use strict";var c=a.exports=b("mosaic-commons");b("./Mosaic.PathMapper");var d=b("underscore");c.ApiDescriptor=c.Class.extend({initialize:function(){this._config={},this._mapper=new c.PathMapper},add:function(a,b,c){if(d.isObject(a)){var e=a;a=e.path,b=e.http,c=e.method}var f=this._config[a]=this._config[a]||{};return f[b]=c,this._mapper.add(a,f),this},get:function(a){return this._mapper.find(a)},exportJson:function(){var a=[],b=this;return d.each(b._config,function(b,c){d.each(b,function(b,d){a.push({path:c,http:d,method:b})})}),a.sort(function(a,b){return a.path>b.path?1:a.path<b.path?-1:0}),a},importJson:function(a){var b=this,c=d.toArray(a);d.each(c,function(a){b.add(a)})}}),d.extend(c.ApiDescriptor,{getDescriptor:function(a){var b=new c.ApiDescriptor,d=c.ApiDescriptor.getDescriptorJson(a);return b.importJson(d),b},getDescriptorJson:function(a){var b=[];return a=d.isFunction(a)?a.prototype:a,d.each(d.functions(a),function(c){var d=a[c];if(d.http&&d.path){var e={method:c,http:d.http,path:d.path};b.push(e)}}),b},bind:function(a,b,c){return c.http=b,c.path=a,c}});var e=c.Class.extend({_wrapHandleMethod:function(a){return function(b,d){var e=this;return c.P.fin(c.P.then(function(){return e._beginHttpCall({req:b,res:d,stub:e})}).then(function(){return a.call(e,b,d)}),function(a,c){return e._endHttpCall({req:b,res:d,stub:e,err:a,result:c})})}},_beginHttpCall:function(a){d.isFunction(this.options.beginHttpCall)&&this.options.beginHttpCall(a)},_endHttpCall:function(a){d.isFunction(this.options.endHttpCall)&&this.options.endHttpCall(a)}});c.ApiDescriptor.HttpServerStub=e.extend({INFO_SUFFIX:".info",initialize:function(a){if(this.setOptions(a),this.descriptor=this.options.descriptor,!this.descriptor){var b=this.options.instance||this;this.descriptor=c.ApiDescriptor.getDescriptor(b)}this._doHandle=this._wrapHandleMethod(this._doHandle)},getDescriptor:function(){return this.descriptor},handle:function(a,b){var d=this;return c.P.then(function(){return d._doHandle(a,b)}).then(function(a){b.send(200,a||"")},function(a){var d=c.Errors.toJSON(a);d.status=d.status||500,b.send(d.status,d)})},_doHandle:function(a,b){var d=this,e=d._getLocalizedPath(a);if(d._isEndpointInfoPath(e)){var f=d.getEndpointJson();return f}var g=a.method.toLowerCase(),h=d.descriptor.get(e);if(!h)throw c.Errors.newError('Path not found "'+e+'"').code(404);var i=h.obj[g];if(!i)throw c.Errors.newError('HTTP method "'+g.toUpperCase()+'" is not supported. Path: "'+e+'".').code(404);return d._callMethod(a,b,i,h.params)},getEndpointJson:function(){var a=this,b=a.getDescriptor(),c=b.exportJson(),d=a.options.path||"";return{endpoint:d,api:c}},_isEndpointInfoPath:function(a){return a.lastIndexOf(this.INFO_SUFFIX)===a.length-this.INFO_SUFFIX.length},_getInstance:function(){var a=this.options||{},b=a.instance||this;return b},_callMethod:function(a,b,d,e){var f=this,g=f._getInstance(a,b,d,e),h=g[d];if(!h)throw c.Errors.newError('Method "'+d+'" is not implemented').code(500);var i=f._getMethodParams(d,e,a,b);return h.call(g,i)},_getMethodParams:function(a,b,c){return d.extend({},c.query,c.body,c.cookies,b)},_getLocalizedPath:function(a){var b=c.ApiDescriptor.HttpServerStub.getPath(a),d=this.options||{},e=d.path||"";return b.substring(e.length)}}),c.ApiDescriptor.HttpServerStub.getPath=function(a){var b=a.path;if(!b||""===b){var c=a.url||"",d=c.indexOf("?");d>=0&&(c=c.substring(0,d)),d=c.indexOf("#"),d>=0&&(c=c.substring(0,d)),d=c.indexOf("/"),d>0&&(c=c.substring(d)),b=c}return b},c.ApiDescriptor.HttpClientStub=e.extend({initialize:function(a){if(!a.descriptor)throw c.Errors.newError("API descriptor is not defined").code(501);var b=this;b.setOptions(a),b.descriptor=b.options.descriptor,b.client=b.options.client||b._newHttpClient(),b.handle=b._wrapHandleMethod(b.handle);var e=b.descriptor._config;d.each(e,function(a,c){d.each(a,function(a,d){b[a]=function(a){var e=b._getFullPath(c,a),f=b.client.newRequest(e,d,a),g=b.client.newResponse(f);return b.handle(f,g)}})})},handle:function(a,b){return this.client.handle(a,b)},_newHttpClient:function(){return b("./Mosaic.HttpClient.Superagent"),new c.HttpClient.Superagent(this.options)},_getFullPath:function(a,b){return c.PathMapper.formatPath(a,b)}}),c.ApiDescriptor.HttpClientStub.load=function(a){var b=new c.HttpClient.Superagent({baseUrl:a}),d=b.newRequest(".info"),e=b.newResponse(d);return b.handle(d,e).then(function(a){var d=a.api,e=new c.ApiDescriptor;return e.importJson(d),new c.ApiDescriptor.HttpClientStub({path:a.endpoint,descriptor:e,client:b})})}}(b,a)},{"./Mosaic.HttpClient.Superagent":3,"./Mosaic.PathMapper":5}],2:[function(a,b){!function(a,b){"use strict";var c=(b("underscore"),b("mosaic-commons"));b("./Mosaic.PathMapper"),b("./Mosaic.ApiDescriptor");c.PathMapper;c.ApiDispatcher=c.Class.extend({initialize:function(a){this.setOptions(a),this.options.path=this._normalizePath(this.options.path),this._mapping=new c.PathMapper},addEndpoint:function(a){var b=this;if(!a.instance)throw c.Errors.newError("API implementation is not defined");if(!a.path)throw c.Errors.newError("Path is not defined");var d=this._getEndpointPath(a.path);a.path=d;var e=new c.ApiDescriptor.HttpServerStub(a),f=d+"*prefix";b._mapping.add(f,e)},register:function(a){var b=this,c=(b.options.path||"")+"/*";a.all(c,function(a,c){b.handle(a,c).done()})},handle:function(a,b){var d=this;return c.P.then(function(){var e=c.ApiDescriptor.HttpServerStub.getPath(a),f=d._find(e);if(f){var g=f.obj;return g.handle(a,b)}throw c.Errors.newError(404,'API handler not found. Path: "'+e+'".')}).then(null,function(a){var d=c.Errors.toJSON(a);d.status=d.status||500,b.send(d.status,d)})},getDescriptorJson:function(a){var b=this,c=b._find(a);if(!c)return null;var d=c.obj,e=d.getEndpointJson();return e},_getEndpointPath:function(a){var b=this,c=b.options.path;return a=c+b._normalizePath(a)},_find:function(a){a=this._normalizePath(a);var b=this._mapping.find(a);return b},_normalizePath:function(a){return a&&""!==a?("/"!=a[0]&&(a="/"+a),"/"===a[a.length-1]&&(a=a.substring(0,a.length-1))):a="",a}})}(b,a)},{"./Mosaic.ApiDescriptor":1,"./Mosaic.PathMapper":5}],3:[function(a,b){!function(a,b){"use strict";var c=a.exports=b("mosaic-commons");b("./Mosaic.HttpClient");var d=b("underscore"),e=b("superagent");c.HttpClient.Superagent=c.HttpClient.extend({initialize:function(a){var b=c.HttpClient.prototype.initialize;b.call(this,a),this.client=e.agent()},http:function(a,b,c){var e=a.method||"get";"delete"==e&&(e="del"),e=e.toLowerCase();var f=this.client[e](a.url);d.each(a.headers,function(a,b){f=f.set(b,a)}),f=f.send(a.body),f.end(function(a,e){try{e?(b.status=e.status,d.extend(b.headers,e.headers||{}),b.body=e.body):b.status=a&&a.status?a.status:500,c(a)}catch(f){c(f)}})}})}(b,a)},{"./Mosaic.HttpClient":4}],4:[function(a,b){!function(a,b){"use strict";var c=a.exports=b("mosaic-commons"),d=b("underscore");c.HttpClient=c.Class.extend({initialize:function(a){if(this.setOptions(a),!this.options.baseUrl)throw c.Errors.newError('The "baseUrl" is not defined.').code(501)},handle:function(a,b){var e=this,f=c.P.defer();try{e.http(a,b,function(a){try{if(!a){var e=parseInt(b.status)/100;if(e=100*parseInt(e),200!=e)if(b.body&&b.body.trace){a=c.Errors.fromJSON(b.body).code(b.status);var g=d.isArray(b.body.trace)?b.body.trace.join("\n"):""+b.body.trace;a.stack=g+"\n\n"+a.stack}else a=c.Errors.newError(""+b.status).code(b.status)}if(a)throw a;f.resolve(b.body)}catch(h){f.reject(h)}})}catch(g){f.reject(g)}return f.promise},newRequest:function(a,b,c,e){b=(b||"get").toUpperCase(),c=c||{},e=e||c||{};var f=this._toUrl(a);return{id:d.uniqueId("req-"),url:f,method:b,query:{},headers:{},body:e}},newResponse:function(a){return{id:a.id,status:200,headers:{},body:null,error:null}},_toUrl:function(a){var b=this.options||{},c=b.baseUrl||"";return c+a},http:function(a,b,d){var e=c.Errors.newError("Not implemented");d(e)}})}(b,a)},{}],5:[function(a,b){!function(a,b){"use strict";function c(a){return a.replace(h,"\\$&")}function d(a){return"("+a+")"}var e=a.exports=b("mosaic-commons"),f=b("underscore"),g=e.PathMapper=e.Class.extend({initialize:function(){var a=this;a.handlers=[]},add:function(a,b){var e=this,g=[],h=[],i=!1;f.each(a.split("*"),function(a){var b=!1;f.each(a.split(":"),function(a){if(i||b){if(i||b){var e=a.indexOf("/"),f=b?"[^/]+":".*?";e>=0?(g.push(d(f)),h.push(a.substring(0,e)),g.push(c(a.substring(e)))):(g.push(d(f)),h.push(a))}}else g.push(c(a));b=!0}),i=!0});var j=g.join(""),k=new RegExp("^"+j+"$");e.handlers.push({mask:a,regexp:k,names:h,obj:b})},find:function(a){var b=this,c=null;return f.any(b.handlers,function(b){if(b.regexp.test(a)){var d={},e=b.regexp.exec(a).slice(1),g=0;return f.each(e,function(a){var c=b.names[g++],e=a?decodeURIComponent(a):null;d[c]=e}),c={params:d,obj:b.obj},!0}}),c},remove:function(a){var b=this,c=null;return b.handlers=f.filter(b.handlers,function(b){var d=!0;return b.mask===a&&(c=b.obj,d=!1),d}),c}});g.formatPath=function(a,b){b=b||{};for(var c=a.split(/[:\*]/gim),d=[],e=0;e<c.length;e++){var f=c[e];if(0===e)""!==f&&d.push(f);else{var g=null,h=f.indexOf("/");h>=0?(g=f.substring(0,h),f=f.substring(h)):(g=f,f=null);var i=b[g];if(!i){var j='Required parameter "'+g+'" not defined.',k=new Error(j);throw k._code=400,k}delete b[g],d.push(i),f&&""!==f&&d.push(f)}}return d.join("")};var h=/[\-{}\[\]+?.,\\\^$|#\s]/g}(b,a)},{}],6:[function(a,b){b.exports=a("mosaic-commons"),a("./Mosaic.ApiDescriptor"),a("./Mosaic.ApiDispatcher"),a("./Mosaic.PathMapper"),a("./Mosaic.HttpClient"),a("./Mosaic.HttpClient.Superagent")},{"./Mosaic.ApiDescriptor":1,"./Mosaic.ApiDispatcher":2,"./Mosaic.HttpClient":4,"./Mosaic.HttpClient.Superagent":3,"./Mosaic.PathMapper":5}]},{},[6])(6)});